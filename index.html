<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Battery Electrode Property Calculator</title>
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Electrode Calculator">
    <meta name="theme-color" content="#2563eb">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQmF0dGVyeSBFbGVjdHJvZGUgUHJvcGVydHkgQ2FsY3VsYXRvciIsInNob3J0X25hbWUiOiJFbGVjdHJvZGUgQ2FsYyIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjZjlmYWZiIiwidGhlbWVfY29sb3IiOiIjMjU2M2ViIiwiaWNvbnMiOlt7InNyYyI6Imh0dHBzOi8vY2RuLWljb25zLXBuZy5mbGF0aWNvbi5jb20vNTEyLzI1LzI1NjE5LnBuZyIsInNpemVzIjoiMTkyeDE5MiIsInR5cGUiOiJpbWFnZS9wbmcifV19">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #f9fafb;
            padding: 1.5rem;
            line-height: 1.5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 2rem;
        }
        .header h1 {
            font-size: 2rem;
            color: #111827;
            margin-bottom: 0.5rem;
        }
        .header p {
            color: #6b7280;
        }
        .mode-badge {
            margin-top: 1rem;
            padding: 0.75rem 1.5rem;
            background: #dbeafe;
            border-radius: 0.5rem;
            display: inline-block;
            color: #1e40af;
            font-weight: 600;
        }
        .card {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .card-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #111827;
            margin-bottom: 1.5rem;
        }
        .section-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.75rem;
        }
        .button-group {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }
        .btn {
            flex: 1;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary {
            background: #2563eb;
            color: white;
        }
        .btn-secondary {
            background: #e5e7eb;
            color: #374151;
        }
        .btn-success {
            background: #16a34a;
            color: white;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .input-group {
            background: #f9fafb;
            padding: 1.25rem;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
        }
        .input-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.75rem;
        }
        .input-group select,
        .input-group input {
            width: 100%;
            padding: 0.625rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }
        .input-group input[type="number"] {
            font-weight: bold;
        }
        .input-with-unit {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .input-with-unit input {
            flex: 1;
            margin-bottom: 0;
        }
        .input-with-unit span {
            font-weight: 600;
            color: #4b5563;
            white-space: nowrap;
        }
        .info-text {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }
        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }
        .result-card {
            padding: 1.25rem;
            border-radius: 0.75rem;
            border: 1px solid;
        }
        .result-card.blue { background: #eff6ff; border-color: #bfdbfe; }
        .result-card.green { background: #f0fdf4; border-color: #bbf7d0; }
        .result-card.purple { background: #faf5ff; border-color: #e9d5ff; }
        .result-card.orange { background: #fff7ed; border-color: #fed7aa; }
        .result-card.yellow { background: #fefce8; border-color: #fde68a; }
        .result-card.pink { background: #fdf2f8; border-color: #fbcfe8; }
        .result-card.cyan { background: #ecfeff; border-color: #a5f3fc; }
        .result-card.indigo { background: #eef2ff; border-color: #c7d2fe; }
        .result-card.violet { background: #f5f3ff; border-color: #ddd6fe; }
        .result-card.amber { background: #fffbeb; border-color: #fde68a; }
        .result-label {
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        .result-card.blue .result-label { color: #1e40af; }
        .result-card.green .result-label { color: #15803d; }
        .result-card.purple .result-label { color: #6b21a8; }
        .result-card.orange .result-label { color: #c2410c; }
        .result-card.yellow .result-label { color: #a16207; }
        .result-card.pink .result-label { color: #be185d; }
        .result-card.cyan .result-label { color: #0e7490; }
        .result-card.indigo .result-label { color: #3730a3; }
        .result-card.violet .result-label { color: #5b21b6; }
        .result-card.amber .result-label { color: #b45309; }
        .result-value {
            font-size: 1.875rem;
            font-weight: bold;
            margin-bottom: 0.25rem;
        }
        .result-card.blue .result-value { color: #1d4ed8; }
        .result-card.green .result-value { color: #16a34a; }
        .result-card.purple .result-value { color: #7c3aed; }
        .result-card.orange .result-value { color: #ea580c; }
        .result-card.yellow .result-value { color: #ca8a04; }
        .result-card.pink .result-value { color: #db2777; }
        .result-card.cyan .result-value { color: #0891b2; }
        .result-card.indigo .result-value { color: #4f46e5; }
        .result-card.violet .result-value { color: #7c3aed; }
        .result-card.amber .result-value { color: #d97706; }
        .result-unit {
            font-size: 0.75rem;
            color: #4b5563;
        }
        .info-box {
            background: linear-gradient(135deg, #dbeafe 0%, #e0e7ff 100%);
            border: 1px solid #93c5fd;
            border-radius: 1rem;
            padding: 2rem;
        }
        .info-box h3 {
            font-size: 1.25rem;
            font-weight: bold;
            color: #111827;
            margin-bottom: 1rem;
        }
        .info-box p {
            color: #374151;
            font-size: 0.875rem;
            margin-bottom: 0.625rem;
            line-height: 1.6;
        }
        .info-box strong {
            color: #1e40af;
        }
        .custom-inputs {
            display: none;
            margin-top: 0.75rem;
        }
        .custom-inputs.active {
            display: block;
        }
        .custom-input-item {
            margin-bottom: 0.75rem;
        }
        .custom-input-item label {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            color: #4b5563;
            margin-bottom: 0.25rem;
        }
        .custom-input-item input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-weight: bold;
        }
        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }
            .header h1 {
                font-size: 1.5rem;
            }
            .card {
                padding: 1.25rem;
            }
            .result-value {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Battery Electrode Property Calculator</h1>
            <p>Calculate electrode density and porosity based on actual battery manufacturing conditions</p>
            <div class="mode-badge">üìê Design Mode</div>
        </div>

        <div class="card">
            <h2 class="card-title">Electrode Configuration</h2>
            <div class="info-text" style="margin-bottom: 1rem; padding: 0.75rem; background: #eff6ff; border-radius: 0.5rem; border: 1px solid #bfdbfe;">
                ‚ÑπÔ∏è All percentages are <strong>by weight (wt%)</strong>
            </div>
            
            <div class="section-title">Electrode Type</div>
            <div class="button-group">
                <button class="btn btn-primary" id="cathodeBtn">Cathode</button>
                <button class="btn btn-secondary" id="anodeBtn">Anode</button>
            </div>

            <div class="grid">
                <div class="input-group">
                    <label>Active Material (wt%)</label>
                    <select id="activeMaterial">
                        <option value="NCM811">NCM811</option>
                        <option value="NCM622">NCM622</option>
                        <option value="LFP">LFP</option>
                        <option value="LCO">LCO</option>
                        <option value="Custom">Custom Active Material</option>
                    </select>
                    <div class="custom-inputs" id="customMaterialInputs">
                        <div class="custom-input-item">
                            <label>Material Name (optional)</label>
                            <input type="text" id="customName" placeholder="e.g., NMC532, LNMO">
                        </div>
                        <div class="custom-input-item">
                            <label>Density (g/cm¬≥)</label>
                            <input type="number" id="customDensity" inputmode="decimal" value="4.00" step="0.01" min="1" max="10">
                        </div>
                        <div class="custom-input-item">
                            <label>Capacity (mAh/g)</label>
                            <input type="number" id="customCapacity" inputmode="decimal" value="180" step="1" min="50" max="1000">
                        </div>
                        <div class="custom-input-item">
                            <label>Nominal Voltage (V)</label>
                            <input type="number" id="customVoltage" inputmode="decimal" value="3.7" step="0.1" min="0.1" max="5.0">
                        </div>
                    </div>
                    <div class="info-text" id="activeMaterialInfo">Density: 4.70 g/cm¬≥<br>Capacity: 200 mAh/g<br>Nominal Voltage: 3.7 V<br>Recommended Voltage Range: 3.0-4.2 V</div>
                    <div class="input-with-unit" style="margin-top: 0.5rem;">
                        <input type="number" id="activeMaterialRatio" inputmode="decimal" value="94" step="0.1" min="80" max="98">
                        <span>%</span>
                    </div>
                </div>

                <div class="input-group">
                    <label>Binder (wt%)</label>
                    <select id="binder">
                        <option value="PVDF">PVDF</option>
                        <option value="SBR">SBR</option>
                        <option value="CMC">CMC</option>
                        <option value="PAA">PAA</option>
                        <option value="Custom">Custom Binder</option>
                    </select>
                    <div class="custom-inputs" id="customBinderInputs">
                        <div class="custom-input-item">
                            <label>Binder Name (optional)</label>
                            <input type="text" id="customBinderName" placeholder="e.g., PVA, PTFE">
                        </div>
                        <div class="custom-input-item">
                            <label>Density (g/cm¬≥)</label>
                            <input type="number" id="customBinderDensity" inputmode="decimal" value="1.50" step="0.01" min="0.5" max="3">
                        </div>
                    </div>
                    <div class="input-with-unit">
                        <input type="number" id="binderRatio" inputmode="decimal" value="3" step="0.1" min="1" max="10">
                        <span>%</span>
                    </div>
                    <div class="info-text" id="binderInfo">Density: 1.78 g/cm¬≥</div>
                </div>

                <div class="input-group">
                    <label>Conductive Additive (wt%)</label>
                    <select id="conductor">
                        <option value="Carbon Black">Carbon Black</option>
                        <option value="Super-P">Super-P</option>
                        <option value="CNT">CNT</option>
                        <option value="Graphene">Graphene</option>
                        <option value="Custom">Custom Conductor</option>
                    </select>
                    <div class="custom-inputs" id="customConductorInputs">
                        <div class="custom-input-item">
                            <label>Conductor Name (optional)</label>
                            <input type="text" id="customConductorName" placeholder="e.g., VGCF, KB">
                        </div>
                        <div class="custom-input-item">
                            <label>Density (g/cm¬≥)</label>
                            <input type="number" id="customConductorDensity" inputmode="decimal" value="2.00" step="0.01" min="0.5" max="3">
                        </div>
                    </div>
                    <div class="input-with-unit">
                        <input type="number" id="conductorRatio" inputmode="decimal" value="3" step="0.1" min="1" max="10">
                        <span>%</span>
                    </div>
                    <div class="info-text" id="conductorInfo">Density: 1.95 g/cm¬≥</div>
                </div>
            </div>

            <div class="grid">
                <div class="input-group">
                    <label>Coating Loading (mg/cm¬≤)</label>
                    <div class="input-with-unit">
                        <input type="number" id="coatingWeight" inputmode="decimal" value="" step="0.1" min="5" max="30" placeholder="e.g., 15.0">
                        <span>mg/cm¬≤</span>
                    </div>
                </div>

                <div class="input-group">
                    <label>Coating Thickness (after compression)</label>
                    <div class="input-with-unit">
                        <input type="number" id="coatingThickness" inputmode="decimal" value="" step="1" min="40" max="150" placeholder="e.g., 80">
                        <span>Œºm</span>
                    </div>
                    <div class="info-text">Enter thickness after calendaring<br>Target porosity 30-40%</div>
                </div>

                <div class="input-group">
                    <label>Coating Area</label>
                    <div class="input-with-unit">
                        <input type="number" id="coatingArea" inputmode="decimal" value="" step="10" min="50" max="500" placeholder="e.g., 100">
                        <span>cm¬≤</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="card" id="resultsCard">
            <h2 class="card-title">Calculation Results (for design)</h2>
            <div class="result-grid" id="resultsGrid"></div>
        </div>

        <div class="card" id="npRatioCard">
            <h2 class="card-title">N/P Ratio Calculation (N/P Ratio Calculation)</h2>
            <div class="info-text" style="margin-bottom: 1rem; padding: 0.75rem; background: #fef3c7; border-radius: 0.5rem; border: 1px solid #fde68a;">
                ‚ÑπÔ∏è N/P Ratio = Cathode capacity / Anode capacity (Recommended: 1.0~1.2)
            </div>
            <div class="input-group" style="max-width: 300px; margin-bottom: 1.5rem;">
                <label>Target N/P Ratio</label>
                <div class="input-with-unit">
                    <input type="number" id="targetNPRatio" inputmode="decimal" value="1.1" step="0.05" min="0.8" max="1.5">
                    <span>-</span>
                </div>
                <div class="info-text">Electrode design target N/P ratio</div>
            </div>
            <div class="result-grid" id="npRatioGrid"></div>
        </div>

        <div class="card" id="experimentalCard">
            <h2 class="card-title">üî¨ Experimental Data Comparison</h2>
            <div class="info-text" style="margin-bottom: 1.5rem; padding: 0.75rem; background: #f0fdf4; border-radius: 0.5rem; border: 1px solid #bbf7d0;">
                ‚ÑπÔ∏è Enter the actual measured discharge capacity in mAh/cm¬≤ or mAh/g (automatically converted)
            </div>
            <div class="grid">
                <div class="input-group">
                    <label>Measured Capacity (Areal Basis)</label>
                    <div class="input-with-unit">
                        <input type="number" id="measuredCapacity" inputmode="decimal" value="" step="0.01" min="0" placeholder="e.g., 2.5">
                        <span>mAh/cm¬≤</span>
                    </div>
                    <div class="info-text">Measured areal discharge capacity from experiments</div>
                </div>
                <div class="input-group">
                    <label>Measured Capacity (Gravimetric Basis)</label>
                    <div class="input-with-unit">
                        <input type="number" id="measuredCapacityGravimetric" inputmode="decimal" value="" step="0.1" min="0" placeholder="e.g., 140">
                        <span>mAh/g</span>
                    </div>
                    <div class="info-text">Measured gravimetric discharge capacity from experiments</div>
                </div>
                <div class="input-group">
                    <label>Measurement C-rate</label>
                    <div class="input-with-unit">
                        <input type="number" id="measuredCrate" inputmode="decimal" value="0.1" step="0.1" min="0.05" max="5">
                        <span>C</span>
                    </div>
                    <div class="info-text">C-rate used during capacity measurement</div>
                </div>
            </div>
            <div class="result-grid" id="experimentalGrid"></div>
        </div>

        <div class="info-box">
            <h3>Calculation Principles</h3>
            <p><strong>Theoretical Density:</strong> œÅ_theoretical = 1 / Œ£(w_i / œÅ_i), Rule of Mixtures method</p>
            <p><strong>Actual Density:</strong> œÅ_actual = coating weight / coating volume, actual density after calendaring</p>
            <p><strong>Porosity:</strong> Œµ = 1 - (œÅ_actual / œÅ_theoretical), electrolyte volume fraction</p>
            <p><strong>‚ö†Ô∏è Calendaring Guide:</strong> Enter coating thickness after calendaring. For target porosity of 30-40%, approximately 40-50% compression from initial thickness is required</p>
            <p><strong>Areal Capacity:</strong> C_areal = loading √ó active material ratio √ó usable capacity</p>
            <p><strong>üí° Usable Capacity:</strong> Entered capacity is the commonly reported usable capacity value from literature (based on specific voltage range)</p>
            <p><strong>Volumetric Energy Density:</strong> E_volumetric = (C_areal √ó nominal voltage) / thickness, (mAh/cm¬≤ √ó V) / cm = Wh/L</p>
            <p><strong>Gravimetric Capacity:</strong> C_gravimetric = total capacity / coating weight (excluding current collector, for paper comparison)</p>
            <p><strong>Active Material Volume Fraction (Solid):</strong> œÜ_solid = (w_a/œÅ_a) / Œ£(w_i/œÅ_i), volume fraction of active material among solid components (considering density differences)</p>
            <p><strong>Active Material Volume Fraction (Electrode):</strong> œÜ_total = (1-Œµ) √ó œÜ_solid, volume fraction of active material in the entire electrode including pores</p>
            <p><strong>‚ö†Ô∏è Note:</strong> Weight fraction ‚â† Volume fraction! Conversion using (w_i/œÅ_i) is necessary due to density differences</p>
            <p><strong>N/P Ratio:</strong> When target N/P ratio is entered, the required relative electrode capacity is automatically calculated. Optimal range is 1.0~1.2 (below 1.0: risk of lithium plating, above 1.2: capacity waste)</p>
            <p><strong>üî¨ Experimental Comparison:</strong> Measured capacity can be entered in mAh/cm¬≤ or mAh/g (automatically converted). Calculates capacity retention and difference compared to design values (85% or higher: good)</p>
            <p><strong>Optimal Conditions:</strong> Porosity 30-40%, loading 10-20 mg/cm¬≤, density 2.5-3.5 g/cm¬≥</p>
        </div>
    </div>

    <script>
        const materials = {
            cathode: {
                'NCM811': { density: 4.70, capacity: 200, nominalVoltage: 3.7, lowerCutoff: 3.0, upperCutoff: 4.2 },
                'NCM622': { density: 4.65, capacity: 180, nominalVoltage: 3.7, lowerCutoff: 3.0, upperCutoff: 4.2 },
                'LFP': { density: 3.60, capacity: 160, nominalVoltage: 3.2, lowerCutoff: 2.5, upperCutoff: 3.65 },
                'LCO': { density: 5.05, capacity: 145, nominalVoltage: 3.9, lowerCutoff: 3.0, upperCutoff: 4.2 }
            },
            anode: {
                'Graphite': { density: 2.26, capacity: 360, nominalVoltage: 0.1, lowerCutoff: 0.01, upperCutoff: 1.5 },
                'Si-Graphite': { density: 2.10, capacity: 450, nominalVoltage: 0.2, lowerCutoff: 0.01, upperCutoff: 1.5 },
                'SiOx': { density: 2.30, capacity: 500, nominalVoltage: 0.2, lowerCutoff: 0.01, upperCutoff: 1.5 },
                'LTO': { density: 3.50, capacity: 175, nominalVoltage: 1.5, lowerCutoff: 1.0, upperCutoff: 2.5 }
            },
            binder: {
                'PVDF': { density: 1.78 },
                'SBR': { density: 1.00 },
                'CMC': { density: 1.60 },
                'PAA': { density: 1.20 }
            },
            conductor: {
                'Carbon Black': { density: 1.95 },
                'Super-P': { density: 2.00 },
                'CNT': { density: 1.35 },
                'Graphene': { density: 2.20 }
            },
            currentCollector: {
                'Al (Cathode)': { density: 2.70, thickness: 15 },
                'Cu (Anode)': { density: 8.96, thickness: 10 }
            }
        };

        let electrodeType = 'cathode';

        const cathodeBtn = document.getElementById('cathodeBtn');
        const anodeBtn = document.getElementById('anodeBtn');
        const activeMaterialSelect = document.getElementById('activeMaterial');
        const customMaterialInputs = document.getElementById('customMaterialInputs');
        const activeMaterialInfo = document.getElementById('activeMaterialInfo');

        cathodeBtn.addEventListener('click', () => {
            electrodeType = 'cathode';
            cathodeBtn.className = 'btn btn-primary';
            anodeBtn.className = 'btn btn-secondary';
            updateActiveMaterialOptions();
            calculate();
        });

        anodeBtn.addEventListener('click', () => {
            electrodeType = 'anode';
            anodeBtn.className = 'btn btn-secondary';
            cathodeBtn.className = 'btn btn-secondary';
            anodeBtn.className = 'btn btn-success';
            updateActiveMaterialOptions();
            calculate();
        });

        function updateActiveMaterialOptions() {
            const materialDB = materials[electrodeType];
            activeMaterialSelect.innerHTML = '';
            Object.keys(materialDB).forEach(mat => {
                const option = document.createElement('option');
                option.value = mat;
                option.textContent = mat;
                activeMaterialSelect.appendChild(option);
            });
            const customOption = document.createElement('option');
            customOption.value = 'Custom';
            customOption.textContent = 'Custom active material';
            activeMaterialSelect.appendChild(customOption);
            updateMaterialInfo();
        }

        function updateMaterialInfo() {
            const material = activeMaterialSelect.value;
            if (material === 'Custom') {
                customMaterialInputs.classList.add('active');
                activeMaterialInfo.style.display = 'none';
            } else {
                customMaterialInputs.classList.remove('active');
                activeMaterialInfo.style.display = 'block';
                const mat = materials[electrodeType][material];
                activeMaterialInfo.innerHTML = `Density: ${mat.density} g/cm¬≥<br>Usable Capacity: ${mat.capacity} mAh/g<br>Nominal Voltage: ${mat.nominalVoltage} V<br>Recommended Voltage Range: ${mat.lowerCutoff}-${mat.upperCutoff} V`;
            }
        }

        activeMaterialSelect.addEventListener('change', () => {
            updateMaterialInfo();
            calculate();
        });

        document.getElementById('binder').addEventListener('change', (e) => {
            const binderType = e.target.value;
            const customBinderInputs = document.getElementById('customBinderInputs');
            const binderInfo = document.getElementById('binderInfo');
            
            if (binderType === 'Custom') {
                customBinderInputs.classList.add('active');
                binderInfo.style.display = 'none';
            } else {
                customBinderInputs.classList.remove('active');
                binderInfo.style.display = 'block';
                const density = materials.binder[binderType].density;
                binderInfo.textContent = `Density: ${density} g/cm¬≥`;
            }
            calculate();
        });

        document.getElementById('conductor').addEventListener('change', (e) => {
            const conductorType = e.target.value;
            const customConductorInputs = document.getElementById('customConductorInputs');
            const conductorInfo = document.getElementById('conductorInfo');
            
            if (conductorType === 'Custom') {
                customConductorInputs.classList.add('active');
                conductorInfo.style.display = 'none';
            } else {
                customConductorInputs.classList.remove('active');
                conductorInfo.style.display = 'block';
                const density = materials.conductor[conductorType].density;
                conductorInfo.textContent = `Density: ${density} g/cm¬≥`;
            }
            calculate();
        });

        const inputIds = ['activeMaterialRatio', 'binderRatio', 'conductorRatio', 'coatingWeight', 'coatingThickness', 'coatingArea', 'customDensity', 'customCapacity', 'customVoltage', 'customBinderDensity', 'customConductorDensity', 'targetNPRatio', 'measuredCapacity', 'measuredCapacityGravimetric', 'measuredCrate'];
        
        inputIds.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('input', calculate);
            }
        });

        // Automatic conversion between areal capacity and gravimetric capacity (after input completion)
        document.getElementById('measuredCapacity').addEventListener('blur', (e) => {
            const arealCap = parseFloat(e.target.value);
            const coatingWeight = parseFloat(document.getElementById('coatingWeight').value);
            if (arealCap && arealCap > 0 && coatingWeight && coatingWeight > 0) {
                const gravCap = (arealCap * 1000) / coatingWeight;
                document.getElementById('measuredCapacityGravimetric').value = gravCap.toFixed(1);
            }
            calculate(); // Recalculate immediately after conversion
        });

        document.getElementById('measuredCapacityGravimetric').addEventListener('blur', (e) => {
            const gravCap = parseFloat(e.target.value);
            const coatingWeight = parseFloat(document.getElementById('coatingWeight').value);
            if (gravCap && gravCap > 0 && coatingWeight && coatingWeight > 0) {
                const arealCap = (gravCap * coatingWeight) / 1000;
                document.getElementById('measuredCapacity').value = arealCap.toFixed(2);
            }
            calculate(); // Recalculate immediately after conversion
        });

        // Automatic recalculation when coating weight changes (after input completion)
        document.getElementById('coatingWeight').addEventListener('blur', () => {
            const arealCap = parseFloat(document.getElementById('measuredCapacity').value);
            const coatingWeight = parseFloat(document.getElementById('coatingWeight').value);
            if (arealCap && arealCap > 0 && coatingWeight && coatingWeight > 0) {
                const gravCap = (arealCap * 1000) / coatingWeight;
                document.getElementById('measuredCapacityGravimetric').value = gravCap.toFixed(1);
            }
            calculate(); // Recalculate immediately after conversion
        });

        function calculate() {
            const activeMaterial = activeMaterialSelect.value;
            let rho_active, capacity, nominalVoltage;
            
            if (activeMaterial === 'Custom') {
                rho_active = parseFloat(document.getElementById('customDensity').value) || 4.0;
                capacity = parseFloat(document.getElementById('customCapacity').value) || 180;
                nominalVoltage = parseFloat(document.getElementById('customVoltage').value) || 3.7;
            } else {
                const mat = materials[electrodeType][activeMaterial];
                rho_active = mat.density;
                capacity = mat.capacity;
                nominalVoltage = mat.nominalVoltage;
            }

            const activeMaterialRatio = parseFloat(document.getElementById('activeMaterialRatio').value) || 94;
            const binderRatio = parseFloat(document.getElementById('binderRatio').value) || 3;
            const conductorRatio = parseFloat(document.getElementById('conductorRatio').value) || 3;
            
            const binder = document.getElementById('binder').value;
            const conductor = document.getElementById('conductor').value;
            
            let rho_binder, rho_conductor;
            
            if (binder === 'Custom') {
                rho_binder = parseFloat(document.getElementById('customBinderDensity').value) || 1.5;
            } else {
                rho_binder = materials.binder[binder].density;
            }
            
            if (conductor === 'Custom') {
                rho_conductor = parseFloat(document.getElementById('customConductorDensity').value) || 2.0;
            } else {
                rho_conductor = materials.conductor[conductor].density;
            }

            const currentCollector = electrodeType === 'cathode' ? 'Al (Cathode)' : 'Cu (Anode)';
            const rho_cc = materials.currentCollector[currentCollector].density;
            const cc_thickness = materials.currentCollector[currentCollector].thickness;

            const coatingWeight = parseFloat(document.getElementById('coatingWeight').value) || 15;
            const coatingThickness = parseFloat(document.getElementById('coatingThickness').value) || 80;
            const coatingArea = parseFloat(document.getElementById('coatingArea').value) || 100;

            const w_active = activeMaterialRatio / 100;
            const w_binder = binderRatio / 100;
            const w_conductor = conductorRatio / 100;

            const rho_theoretical = 1 / ((w_active / rho_active) + (w_binder / rho_binder) + (w_conductor / rho_conductor));

            const totalMass = coatingWeight * coatingArea;
            const coatingVolume = coatingThickness * 1e-4 * coatingArea;
            const rho_actual = totalMass / 1000 / coatingVolume;

            const porosity = 1 - (rho_actual / rho_theoretical);
            const porosityPercent = porosity * 100;

            const areal_capacity = coatingWeight * w_active * capacity / 1000;
            
            // Calculation of active material volume fraction (correct method)
            const denom = (w_active / rho_active) + (w_binder / rho_binder) + (w_conductor / rho_conductor);
            const phi_active_solid = (w_active / rho_active) / denom; // Volume fraction of active material in solid
            const phi_active_total = (1 - porosity) * phi_active_solid; // Volume fraction of active material in electrode
            
            const coatingThickness_cm = coatingThickness * 1e-4;
            const energy_density_volumetric = (areal_capacity * nominalVoltage) / coatingThickness_cm;

            const coating_weight_g = totalMass / 1000;
            const total_capacity = areal_capacity * coatingArea;
            const gravimetric_capacity = total_capacity / coating_weight_g;

            const cc_weight = rho_cc * cc_thickness * 1e-4 * coatingArea;
            const total_weight = cc_weight + coating_weight_g;

            // N/P Ratio calculation (based on target N/P ratio)
            const targetNPRatio = parseFloat(document.getElementById('targetNPRatio').value) || 1.1;
            let requiredCounterCapacity, npRatioStatus;
            
            if (electrodeType === 'cathode') {
                // Designing cathode: Required anode capacity = cathode capacity √ó N/P ratio
                requiredCounterCapacity = areal_capacity * targetNPRatio;
                npRatioStatus = targetNPRatio >= 1.0 && targetNPRatio <= 1.2 ? 'Optimal' : targetNPRatio < 1.0 ? '‚ö†Ô∏è Risk of lithium plating' : '‚ö†Ô∏è Capacity waste';
            } else {
                // Designing anode: Required cathode capacity = anode capacity / N/P ratio
                requiredCounterCapacity = areal_capacity / targetNPRatio;
                npRatioStatus = targetNPRatio >= 1.0 && targetNPRatio <= 1.2 ? 'Optimal' : targetNPRatio < 1.0 ? '‚ö†Ô∏è Risk of lithium plating' : '‚ö†Ô∏è Capacity waste';
            }

            const results = [
                { label: 'Theoretical Density', value: rho_theoretical.toFixed(3), unit: 'g/cm¬≥', color: 'blue' },
                { label: 'Actual Density', value: rho_actual.toFixed(3), unit: 'g/cm¬≥', color: 'green' },
                { label: 'Porosity', value: porosityPercent.toFixed(2), unit: '%', color: 'purple' },
                { label: 'Loading', value: coatingWeight.toFixed(2), unit: 'mg/cm¬≤', color: 'orange' },
                { label: 'Areal Capacity', value: areal_capacity.toFixed(2), unit: 'mAh/cm¬≤', color: 'yellow' },
                { label: 'Volumetric Energy Density', value: energy_density_volumetric.toFixed(1), unit: 'Wh/L', color: 'pink' },
                { label: 'Volumetric Capacity', value: (areal_capacity / coatingThickness_cm).toFixed(1), unit: 'mAh/cm¬≥', color: 'cyan' },
                { label: 'Gravimetric Capacity', value: gravimetric_capacity.toFixed(1), unit: 'mAh/g', color: 'indigo' },
                { label: 'Active Material Volume Fraction (Solid)', value: phi_active_solid.toFixed(3), unit: '-', color: 'violet' },
                { label: 'Active Material Volume Fraction (Electrode)', value: phi_active_total.toFixed(3), unit: '-', color: 'amber' },
                { label: 'Nominal Voltage', value: nominalVoltage.toFixed(2), unit: 'V', color: 'blue' }
            ];

            const npRatioResults = [
                { label: electrodeType === 'cathode' ? 'Cathode Capacity (Design)' : 'Anode Capacity (Design)', value: areal_capacity.toFixed(2), unit: 'mAh/cm¬≤', color: 'blue' },
                { label: electrodeType === 'cathode' ? 'Required Anode Capacity' : 'Required Cathode Capacity', value: requiredCounterCapacity.toFixed(2), unit: 'mAh/cm¬≤', color: 'green' },
                { label: 'Target N/P Ratio', value: targetNPRatio.toFixed(2), unit: '-', color: 'amber' },
                { label: 'Status', value: npRatioStatus, unit: '', color: targetNPRatio >= 1.0 && targetNPRatio <= 1.2 ? 'green' : 'orange' }
            ];

            displayResults(results, 'resultsGrid');
            displayResults(npRatioResults, 'npRatioGrid');

            // Experimental data comparison
            const measuredCapacity = parseFloat(document.getElementById('measuredCapacity').value);
            if (measuredCapacity && measuredCapacity > 0) {
                const capacityRetention = (measuredCapacity / areal_capacity) * 100;
                const capacityDifference = measuredCapacity - areal_capacity;
                const measuredGravimetricCapacity = (measuredCapacity * coatingArea) / coating_weight_g;
                const measuredVolumetricEnergy = (measuredCapacity * nominalVoltage) / coatingThickness_cm;
                const energyRetention = (measuredVolumetricEnergy / energy_density_volumetric) * 100;
                
                let retentionStatus;
                if (capacityRetention >= 95) {
                    retentionStatus = '‚úÖ Excellent';
                } else if (capacityRetention >= 85) {
                    retentionStatus = '‚úì Good';
                } else if (capacityRetention >= 70) {
                    retentionStatus = '‚ö†Ô∏è Fair';
                } else {
                    retentionStatus = '‚ö†Ô∏è Poor';
                }

                const experimentalResults = [
                    { label: 'Design Capacity', value: areal_capacity.toFixed(2), unit: 'mAh/cm¬≤', color: 'blue' },
                    { label: 'Measured Capacity', value: measuredCapacity.toFixed(2), unit: 'mAh/cm¬≤', color: 'green' },
                    { label: 'Capacity Retention', value: capacityRetention.toFixed(1), unit: '%', color: capacityRetention >= 85 ? 'green' : 'orange' },
                    { label: 'Capacity Difference', value: capacityDifference.toFixed(2), unit: 'mAh/cm¬≤', color: capacityDifference >= 0 ? 'cyan' : 'pink' },
                    { label: 'Measured Gravimetric Cap.', value: measuredGravimetricCapacity.toFixed(1), unit: 'mAh/g', color: 'indigo' },
                    { label: 'Design Energy Density', value: energy_density_volumetric.toFixed(1), unit: 'Wh/L', color: 'violet' },
                    { label: 'Measured Energy Density', value: measuredVolumetricEnergy.toFixed(1), unit: 'Wh/L', color: 'purple' },
                    { label: 'Energy Retention', value: energyRetention.toFixed(1), unit: '%', color: energyRetention >= 85 ? 'green' : 'orange' },
                    { label: 'Status', value: retentionStatus, unit: '', color: capacityRetention >= 85 ? 'green' : 'orange' }
                ];
                
                displayResults(experimentalResults, 'experimentalGrid');
            } else {
                document.getElementById('experimentalGrid').innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #6b7280; padding: 2rem;">Please enter the actual measured discharge capacity</div>';
            }
        }

        function displayResults(results, gridId) {
            const grid = document.getElementById(gridId);
            grid.innerHTML = results.map(r => `
                <div class="result-card ${r.color}">
                    <div class="result-label">${r.label}</div>
                    <div class="result-value">${r.value}</div>
                    <div class="result-unit">${r.unit}</div>
                </div>
            `).join('');
        }

        window.addEventListener('DOMContentLoaded', function() {
            calculate();
        });
    </script>
</body>
</html>